<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Finance & Credit Card Tracker</title>
<style>
  :root{
    --bg:#F7F8FB; --panel:#FFFFFF; --panel-2:#F3F5F9; --border:#E3E8EF;
    --text:#0B1220; --muted:#5B6474; --muted-2:#7A8596; --accent:#2B73F7; --ring:#9BB8FF;
    --shadow:0 1px 2px rgba(16,24,40,.06), 0 6px 20px rgba(16,24,40,.06);
    --radius:16px; --cols-3: 1fr 1.6fr 1fr; --gradient-alpha: .06;
    --content-max: 2200px; --sidebar-w: 264px; --sidebar-w-collapsed: 64px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans"}
  .app{max-width:var(--content-max);margin:0 auto;padding:16px 16px 24px}
  .layout{display:grid;gap:16px}
  .sidebar{
    background:var(--panel);
   border:1px solid var(--border);
   border-radius:var(--radius);
   box-shadow:var(--shadow);
   padding:12px;
   position:sticky;
   top:12px;
  height:calc(100vh - 24px);
   display:flex;
   flex-direction:column;
   overflow:hidden;
}
  .brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .brand .logo{width:28px;height:28px;border-radius:8px;background:var(--accent);background-size:cover;background-position:center center}
  .brand .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .collapse-btn{border:1px solid var(--border);background:var(--panel-2);border-radius:10px;padding:6px 8px;cursor:pointer}
  .nav{display:flex;flex-direction:column;gap:4px;margin-top:8px}
  .nav .item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;cursor:pointer;border:1px solid transparent}
  .nav .item:hover{background:var(--panel-2)}
  .nav .item.active{background:var(--panel-2);border-color:var(--border)}
  .nav .icon{width:26px;height:26px;border-radius:8px;display:inline-grid;place-items:center;background:var(--panel-2);font-size:12px}
  .spacer{flex:1}
  .foot{display:flex;flex-direction:column;gap:8px}
  .switch{position:relative;width:48px;height:26px;background:var(--panel-2);border:1px solid var(--border);border-radius:999px;cursor:pointer}
  .switch .knob{position:absolute;top:1px;left:1px;width:24px;height:24px;border:1px solid var(--border);background:var(--panel);border-radius:50%;transition:left .18s}
  .switch.on .knob{left:23px}
  .main{min-height:60vh}
  .header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:8px}
  h1{font-size:20px;margin:0;font-weight:800}
  .muted{color:var(--muted);font-size:12px}
  .btn{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:8px 12px;cursor:pointer;transition:.12s}
  .btn:hover{background:var(--panel-2)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.tiny{padding:6px 8px;border-radius:10px;font-size:12px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .p4{padding:14px}
  .grid{display:grid;gap:14px}
  .grid-3{grid-template-columns: var(--cols-3)}
  .grid-2{grid-template-columns: repeat(2,minmax(0,1fr))}
  .grid-1{grid-template-columns: 1fr}
  @media (max-width:1100px){ .grid-3,.grid-2{grid-template-columns: 1fr} }
  .kpi{border-radius:12px;padding:12px;border:1px solid var(--border);background:var(--panel)}
  .kpi .label{font-size:11px;color:var(--muted)}
  .kpi .value{font-size:20px;font-weight:700;margin-top:6px}
  .title{font-weight:700;margin-bottom:8px;font-size:14px}
  .field label{font-size:12px;color:var(--muted);display:block}
  .field input,.field select,.field textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);outline:none}
  .field input:hover,.field select:hover,.field textarea:hover{background:var(--panel-2)}
  .field input:focus,.field select:focus,.field textarea:focus{box-shadow:0 0 0 3px var(--ring)}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  .drag{cursor:grab}
  .drag.dragging{opacity:.6}
  .placeholder{border:2px dashed var(--border);border-radius:var(--radius);min-height:80px}
  .card{position:relative;border-radius:var(--radius);border:1px solid var(--border);padding:16px;background:var(--panel);box-shadow:var(--shadow);transition:transform .12s}
  .card:hover{transform:translateY(-1px)}
  .badge{position:absolute;top:8px;right:8px;font-size:11px;padding:4px 8px;border-radius:999px}
  .warn{background:#FFF3D6;color:#A66B00}
  .bad{background:#FDE2E2;color:#B42318}
  .cal{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px}
  .cal .cell{min-height:84px;border:1px solid var(--border);border-radius:12px;padding:6px;overflow:hidden;background:var(--panel)}
  .cal .dow{text-align:center;color:var(--muted);font-size:11px}
  .dot{width:8px;height:8px;border-radius:9999px;display:inline-block;margin-right:4px}
  .customise-bar{position:sticky;top:12px;z-index:5;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--panel-2);color:var(--text);padding:6px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
  .sizepick{display:inline-flex;border:1px solid var(--border);border-radius:8px;overflow:hidden}
  .sizepick button{padding:4px 8px;background:transparent;border:0;cursor:pointer;font-size:12px}
  .sizepick button[aria-pressed="true"]{background:var(--accent);color:#fff}
  .toast{position:fixed;right:16px;bottom:16px;background:var(--panel);color:var(--text);border:1px solid var(--border);box-shadow:var(--shadow);border-radius:12px;padding:12px 14px;z-index:9999;max-width:360px}
  .toast h3{margin:0 0 4px;font-size:14px}
  .toast .muted{font-size:12px;margin-bottom:8px}
  .palette{display:flex;gap:6px;flex-wrap:wrap}
  .swatch{width:28px;height:28px;border-radius:8px;border:1px solid var(--border);cursor:pointer}
</style>
</head>
<body>
<div class="app" id="app"><div id="boot">Loading appâ€¦</div></div>

<script src="utils.js"></script>
<script>
/* ---------- Early widget registry (prevents undefined errors) ---------- */
window.WidgetRegistry = window.WidgetRegistry || {}; // global
const WidgetRegistry = window.WidgetRegistry;

/* ---------- Utilities ---------- */
const $ = (s,el=document)=>el.querySelector(s);
const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const todayISO=()=>new Date().toISOString().slice(0,10);
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const daysBetween = (a,b) => { const A=new Date(a), B=new Date(b); A.setHours(0,0,0,0); B.setHours(0,0,0,0); return Math.round((B-A)/86400000) };
const fmtUSD = (n) => (n==null || isNaN(n) ? 'â€”' : Number(n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}));
const asNumber = (v) => {
  if (v === '' || v == null) return null;
  const n = Number(String(v).replace(/,/g,''));
  return isNaN(n) ? null : n;
};
const hexToRgb = (hex) => { const m = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex||'#3b82f6'); return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:59,g:130,b:246}; };
function h(tag, attrs={}, ...children){
  const el=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==='class') el.className=v;
    else if(k.startsWith('on')&&typeof v==='function') el.addEventListener(k.slice(2).toLowerCase(), v, {passive:true});
    else if(k==='style'&&typeof v==='object') el.setAttribute('style', Object.entries(v).map(([a,b])=>`${a}:${b}`).join(';'));
    else if(v!==false && v!=null) el.setAttribute(k, v===true?'':v);
  }
  for(const c of children.flat()){
    if(c==null||c===false) continue;
    if(typeof c==='string' || typeof c==='number' || typeof c==='boolean') el.appendChild(document.createTextNode(String(c)));
    else el.appendChild(c);
  }
  return el;
}
function showToast(title, msg, actions=[]){
  const t=h('div',{class:'toast'}, h('h3',null,title), h('div',{class:'muted'},msg));
  const row=h('div',null);
  actions.forEach(({label,fn,primary})=>{
    const b=h('button',{class:'btn tiny'+(primary?' primary':''), onclick:()=>{ try{fn&&fn();}finally{t.remove();}}}, label);
    row.appendChild(b);
  });
  row.appendChild(h('button',{class:'btn tiny',onclick:()=>t.remove()},'Close'));
  t.appendChild(row); document.body.appendChild(t); setTimeout(()=>{ if(document.body.contains(t)) t.remove(); }, 8000);
}
window.addEventListener('error', e=>{ console.error(e.error||e.message); showToast('App error', String(e.error?.message||e.message||'Unknown'), [{label:'Repair',primary:true,fn:()=>hardRepair()},{label:'Reload',fn:()=>location.reload()}]); });
window.addEventListener('unhandledrejection', e=>{ console.error(e.reason); showToast('App error', String(e.reason), [{label:'Repair',primary:true,fn:()=>hardRepair()},{label:'Reload',fn:()=>location.reload()}]); });

/* ---------- Theme presets ---------- */
const ThemePresets = {
  light: {
    cloud:     { bg:'#F7F8FB', panel:'#FFFFFF', panel2:'#F3F5F9', border:'#E3E8EF', text:'#0B1220', muted:'#5B6474', muted2:'#7A8596', accent:'#2B73F7', ring:'#9BB8FF', shadow:'0 1px 2px rgba(16,24,40,.06), 0 6px 20px rgba(16,24,40,.06)' },
    cloudContrast: { bg:'#EEF2F7', panel:'#FFFFFF', panel2:'#EEF1F6', border:'#D9E0EA', text:'#0A0F1A', muted:'#4D5461', muted2:'#6B7280', accent:'#2C6BED', ring:'#A7BDFE', shadow:'0 1px 2px rgba(10,15,26,.07), 0 8px 24px rgba(10,15,26,.07)' }
  },
  dark: {
    obsidian:  { bg:'#0D1117', panel:'#111827', panel2:'#0F172A', border:'#263040', text:'#E6EDF3', muted:'#9BA7B4', muted2:'#7E8B98', accent:'#2B73F7', ring:'#2B73F7', shadow:'0 1px 2px rgba(0,0,0,.5), 0 8px 24px rgba(0,0,0,.35)' },
    nightBlue: { bg:'#0B1220', panel:'#0F172A', panel2:'#101A2E', border:'#1E293B', text:'#E4EAF2', muted:'#A5B1C0', muted2:'#8894A3', accent:'#3A7BFF', ring:'#3A7BFF', shadow:'0 1px 2px rgba(0,0,0,.55), 0 10px 28px rgba(0,0,0,.4)' }
  }
};
function applyThemeTokens(){
  const mode = state.theme || 'light';
  const preset = (mode==='dark' ? state.themeDarkPreset : state.themeLightPreset) || (mode==='dark' ? 'obsidian' : 'cloud');
  const tokens = ThemePresets[mode][preset];
  const root = document.documentElement;

  // Content width (ultrawide support)
  root.style.setProperty('--content-max',
    state.ui?.fullWidth ? '100vw' : ((state.ui?.contentMaxPx || 2200) + 'px')
  );

  root.style.setProperty('--bg', tokens.bg);
  root.style.setProperty('--panel', tokens.panel);
  root.style.setProperty('--panel-2', tokens.panel2);
  root.style.setProperty('--border', tokens.border);
  root.style.setProperty('--text', tokens.text);
  root.style.setProperty('--muted', tokens.muted);
  root.style.setProperty('--muted-2', tokens.muted2);
  root.style.setProperty('--accent', state.accentColor || tokens.accent);
  root.style.setProperty('--ring', tokens.ring);
  root.style.setProperty('--shadow', tokens.shadow);
  root.style.setProperty('--radius', (state.ui?.radiusPx || 16) + 'px');
  root.style.setProperty('--cols-3', `1fr ${state.ui?.centerWeight || 1.6}fr 1fr`);
  root.style.setProperty('--gradient-alpha', String(state.ui?.gradientAlpha ?? 0.06));
}

/* ---------- Storage & State ---------- */
const STORAGE_KEY='cc-finance-tracker-v27'; /* keep your data */
let state = load() || seed();
function seed(){
  const c1={id:uid(),name:'Company Visa (Chase)',issuer:'Chase',limit:25000,apr:18.99,fixedDueDay:12,fixedCloseDay:15,color:'#3b82f6',utilTarget:30,useGradient:true};
  const a1={id:uid(),name:'Operating Checking',bank:'',number:'...1234',type:'bank',color:'#0ea5e9'};
  const l1={id:uid(),name:'Van Loan',bank:'',number:'...9012',type:'loan',apr:6.5,color:'#f97316'};
  return {
   company:'Company Finance', logoData:'',
   theme:'light', themeLightPreset:'cloud', themeDarkPreset:'obsidian', accentColor:'#2B73F7',
   section:'overview', ccView:'dashboard', finView:'dashboard',
   ui:{
     sidebarCollapsed:false, centerWeight:1.6, gradientAlpha:.06, radiusPx:16,
     customizing:null, ccDraft:{}, finDraft:{}, histFilter:{mode:'selected',from:'',to:''},
     companyDraft:'',
     // NEW:
     fullWidth:false,
     contentMaxPx:2200,
     colCount:{overview:3, credit:3, financials:3},
     ccCardsCols:2
   },
   cards:[c1], entries:[], selectedCardId:c1.id,
   finAccounts:[a1,l1], finEntries:[], finExpenses:[],
   order_overview:['ov_finKpis','ov_ccLine','ov_netLine'],
   order_cc:['cc_cardsGrid','cc_kpis','cc_line','cc_availLine','cc_remainLine','cc_bar','cc_remainBar','cc_dueSoon','cc_utilLadder','cc_changedToday','cc_payCalendar','cc_agingBuckets','cc_exposureIssuer'],
   order_fin:['fin_kpis','fin_cashLine','fin_debtLine','fin_netLine','fin_upcoming'],
   widgetSize:{}, widgetHeightMode:{}, widgetFixedH:{},
   // NEW:
   widgetCfg:{},
   widgetCol:{},            // widgetId -> column index (1..N)
   cardOrder:[]            // array of card ids for Cards Overview ordering
 };
}
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);

    // Defensive migrations
    ['order_overview','order_cc','order_fin'].forEach(k=>{
      if(!Array.isArray(obj[k])) obj[k] = [];
    });

    // Existing fields
    obj.ui = obj.ui || {};
    obj.ui.companyDraft = obj.ui.companyDraft || '';
    obj.widgetCfg = obj.widgetCfg || {};

    // â¬‡ï¸ ADD THESE DEFAULTS
    obj.ui.colCount = obj.ui.colCount || { overview:3, credit:3, financials:3 };
    if (obj.ui.ccCardsCols == null) obj.ui.ccCardsCols = 2;
    obj.widgetCol = obj.widgetCol || {};
    obj.cardOrder = obj.cardOrder || [];

    return obj;
  }catch{
    return null;
  }
}

/* ---------- Derived / KPIs with caching ---------- */
const cache={vers:{cards:0,entries:0,finAccounts:0,finEntries:0}, latestByCard:null, kpisCC:null, sTotal:null,sAvail:null,sRemain:null, finLatest:null,finKPIs:null};
function bump(k){ cache.vers[k]=(cache.vers[k]||0)+1; }
function latestByCard(){
  if (cache.latestByCard && cache.latestByCard._vC===cache.vers.cards && cache.latestByCard._vE===cache.vers.entries) return cache.latestByCard;
  const map=Object.fromEntries(state.cards.map(c=>[c.id,null])); for(const e of state.entries){ if(!map[e.cardId] || e.date>map[e.cardId]?.date) map[e.cardId]=e; }
  cache.latestByCard=Object.assign(map,{_vC:cache.vers.cards,_vE:cache.vers.entries}); return cache.latestByCard;
}
function kpisCC(){
  if (cache.kpisCC && cache.kpisCC._vC===cache.vers.cards && cache.kpisCC._vE===cache.vers.entries) return cache.kpisCC;
  const latest=latestByCard(); let totalBalance=0,totalDueSoon=0,utilSum=0,utilCount=0,totalOverLimit=0,totalAvail=0,totalRemain=0; const now=todayISO();
  for(const c of state.cards){ const last=latest[c.id];
    if (last?.totalBalance!=null) totalBalance += Number(last.totalBalance)||0;
    if (c.limit && last?.totalBalance!=null){ utilSum += (Number(last.totalBalance)/Number(c.limit)); utilCount++; }
    if (last?.dueDate){ const d=daysBetween(now,last.dueDate); if (d<=5 && last.amountDue) totalDueSoon += Number(last.amountDue)||0; }
    if (last?.overLimit) totalOverLimit += Number(last.overLimit)||0;
    if (last?.availableCredit!=null) totalAvail += Number(last.availableCredit)||0;
    if (last?.amountDue!=null) totalRemain += Number(last.amountDue)||0;
  }
  cache.kpisCC={totalBalance,totalDueSoon,avgUtil: utilCount?utilSum/utilCount:null,totalOverLimit,totalAvail,totalRemain,_vC:cache.vers.cards,_vE:cache.vers.entries}; return cache.kpisCC;
}
function summedSeries(key){
  const memoKey=key==='totalBalance'?'sTotal': key==='availableCredit'?'sAvail':'sRemain';
  if (cache[memoKey] && cache[memoKey]._v===cache.vers.entries) return cache[memoKey];
  const m=new Map(); for(const e of state.entries){ const s=(m.get(e.date)||0)+(Number(e[key])||0); m.set(e.date,s); }
  const out=Array.from(m.entries()).sort((a,b)=>a[0].localeCompare(b[0])).map(([date,y])=>({date,y}));
  cache[memoKey]=Object.assign(out,{_v:cache.vers.entries}); return out;
}
function getAcc(id){ return state.finAccounts.find(a=>a.id===id); }
function finLatestByAccount(){
  if (cache.finLatest && cache.finLatest._vA===cache.vers.finAccounts && cache.finLatest._vE===cache.vers.finEntries) return cache.finLatest;
  const map=Object.fromEntries(state.finAccounts.map(a=>[a.id,null])); for(const e of state.finEntries){ const cur=map[e.accountId]; if(!cur||e.date>cur.date) map[e.accountId]=e; }
  cache.finLatest=Object.assign(map,{_vA:cache.vers.finAccounts,_vE:cache.vers.finEntries}); return cache.finLatest;
}
function finKPIs(){
  if (cache.finKPIs && cache.finKPIs._vA===cache.vers.finAccounts && cache.finKPIs._vE===cache.vers.finEntries) return cache.finKPIs;
  const m=finLatestByAccount(); let cash=0,debt=0; for(const a of state.finAccounts){ const bal=Number(m[a.id]?.balance)||0; if(a.type==='bank') cash+=bal; else if(a.type==='loan') debt+=bal; }
  cache.finKPIs={cash,debt,net:cash-debt,_vA:cache.vers.finAccounts,_vE:cache.vers.finEntries}; return cache.finKPIs;
}
/* ---------- Widget configuration helpers ---------- */
function defaultWidgetCfg(id){
  return {
    chartType:'auto',       // auto | line | bar | pie
    color:null,             // single-series color
    palette:'card',         // card | mono
    yMin:null, yMax:null,   // axis overrides
    from:'', to:'',         // date filter
    cards:'all',            // all | [cardIds]
    sort:{by:null, dir:'desc'},
    groupBy:null            // e.g., 'issuer'
  };
}
function getCfg(id){ return state.widgetCfg[id] || defaultWidgetCfg(id); }
function setCfg(id,patch){ state.widgetCfg[id]=Object.assign(getCfg(id), patch); save(); }

// Filters / utils
function filterSeriesByCfg(series, cfg){
  return series.filter(p => (!cfg.from || p.date>=cfg.from) && (!cfg.to || p.date<=cfg.to));
}
function filterCardsByCfg(cards, cfg){
  if (!cards || !cards.length) return cards;
  if (cfg.cards==='all' || !Array.isArray(cfg.cards)) return cards;
  const set = new Set(cfg.cards); return cards.filter(c => set.has(c.id));
}
function subtotalBy(items, groupKey, valueKey){
  const map=new Map();
  items.forEach(it=>{
    const k = it[groupKey] ?? 'â€”';
    const v = Number(it[valueKey])||0;
    map.set(k,(map.get(k)||0)+v);
  });
  return Array.from(map.entries()).map(([label,value])=>({label,value}));
}
function sortBy(list, key, dir='desc'){
  const s = list.slice().map((x,i)=>({x,i}));
  s.sort((a,b)=>{
    const va=a.x[key], vb=b.x[key];
    const cmp = (va>vb)-(va<vb) || (a.i-b.i);
    return dir==='asc'? cmp : -cmp;
  });
  return s.map(w=>w.x);
}

/* ---------- Charts ---------- */
function lineChart(data,{height=160,color,yMin=null,yMax=null}={}){
  if(!data||!data.length) return h('div',{class:'muted'},'No data');
  const W=720,H=height,P=28;
  const ys=data.map(d=>Number(d.y)||0);
  let min=Math.min(...ys), max=Math.max(...ys);
  if (yMin!=null) min = Number(yMin);
  if (yMax!=null) max = Number(yMax);
  const range=(max-min)||1;
  const step=(W-P*2)/Math.max(1,data.length-1);
  const pts=data.map((d,i)=>[P+i*step, P+(H-P*2)*(1-((Number(d.y)-min)/range))]);
  const dPath=pts.map(([x,y],i)=>(i?'L':'M')+x.toFixed(1)+','+y.toFixed(1)).join(' ');
  return h('svg',{viewBox:`0 0 ${W} ${H}`, style:{width:'100%',height:(H+20)+'px'}},
    h('path',{d:dPath,fill:'none',stroke:color||'currentColor','stroke-width':'2'})
  );
}
function barChart(items,{colors=[],valueSuffix='',currency=false,yMin=null,yMax=null}={}){
  if(!items||!items.length) return h('div',{class:'muted'},'No data');
  const W=720,H=200,P=28,G=12,N=items.length,BAR=(W-P*2-(N-1)*G)/Math.max(1,N);
  let vals=items.map(i=>Number(i.value)||0);
  let minVal=Math.min(0,...vals), maxVal=Math.max(1,...vals);
  if (yMin!=null) minVal=Number(yMin);
  if (yMax!=null) maxVal=Number(yMax);
  const span=(maxVal-minVal)||1;
  const g=h('svg',{viewBox:`0 0 ${W} ${H}`, style:{width:'100%',height:'210px'}});
  items.forEach((it,idx)=>{
    const x=P+idx*(BAR+G);
    const val=Number(it.value)||0;
    const ratio=(val-minVal)/span;
    const bh=(H-P*2)*ratio;
    const y=H-P-bh;
    const fill=colors[idx]||'currentColor';
    g.appendChild(h('rect',{x,y,width:BAR,height:bh,fill,opacity:.22}));
    g.appendChild(h('text',{x:x+BAR/2,y:H-8,'text-anchor':'middle',style:'font-size:10px;fill:var(--muted);'}, (it.label||'').slice(0,16)+(it.label&&it.label.length>16?'â€¦':'')));
    const top=currency?('$'+val.toLocaleString()):(val+valueSuffix);
    g.appendChild(h('text',{x:x+BAR/2,y:y-4,'text-anchor':'middle',style:'font-size:10px;fill:var(--muted);'}, top));
  });
  return g;
}
function pieChart(items,{colors=[]}={}){
  if(!items||!items.length) return h('div',{class:'muted'},'No data');
  const W=220,H=220,R=90,CX=W/2,CY=H/2;
  const total=items.reduce((s,i)=>s+(Number(i.value)||0),0)||1;
  let a0=0;
  const g=h('svg',{viewBox:`0 0 ${W} ${H}`, style:{width:'100%',height:'240px'}});
  items.forEach((it,idx)=>{
    const v=Math.max(0, Number(it.value)||0);
    const a1=a0 + (v/total)*Math.PI*2;
    const x0=CX+R*Math.cos(a0), y0=CY+R*Math.sin(a0);
    const x1=CX+R*Math.cos(a1), y1=CY+R*Math.sin(a1);
    const large = (a1-a0) > Math.PI ? 1 : 0;
    const path = `M ${CX} ${CY} L ${x0} ${y0} A ${R} ${R} 0 ${large} 1 ${x1} ${y1} Z`;
    g.appendChild(h('path',{d:path,fill:colors[idx]||'currentColor',opacity:.85}));
    a0=a1;
  });
  return g;
}

/* ---------- Small UI helpers ---------- */
function sectionTitle(t){ return h('div',{class:'title'}, t); }
function kpi(label,value){ return h('div',{class:'kpi'}, h('div',{class:'label'},label), h('div',{class:'value'}, value)); }
function fieldInput(label,value,onChange,type='text'){ return h('div',{class:'field'}, h('label',null,label), h('input',{type,value:value??'',oninput:e=>onChange(e.target.value)})); }
function currencyInput(value,onChange,label){ const f=h('div',{class:'field'}, label?h('label',null,label):null,
  h('div',{style:'position:relative;'}, h('span',{style:'position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);'},'$'),
    h('input',{type:'text',value:value==null?'':String(value),style:'padding-left:22px;',oninput:e=>{const raw=e.target.value.replace(/[^0-9.\\-]/g,'');onChange(raw);},onfocus:e=>{e.target.value=e.target.value.replace(/,/g,'');},onblur:e=>{const n=asNumber(e.target.value);e.target.value=(n==null?'':Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}));onChange(e.target.value);}}))); return f; }
function percentInput(value,onChange,label){ const f=h('div',{class:'field'}, label?h('label',null,label):null,
  h('div',{style:'position:relative;'},
    h('input',{type:'text',value:value==null?'':String(value),style:'padding-right:22px;',oninput:e=>{const raw=e.target.value.replace(/[^0-9.\\-]/g,'');onChange(raw);},onblur:e=>{const n=Number(e.target.value);e.target.value=isFinite(n)?n.toFixed(2):'';onChange(e.target.value);}}),
    h('span',{style:'position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--muted);'},'%'))); return f; }
function widget(id, content, size, heightMode){ const el=h('section',{class:'panel p4 drag',draggable:'true','data-widget-id':id, style:`grid-column: span ${Math.max(1,Math.min(3,size||1))}`}, content);
  const hmode = heightMode || state.widgetHeightMode[id] || 'auto';
  let hpx = null; if (hmode==='short') hpx=240; else if(hmode==='medium') hpx=340; else if(hmode==='tall') hpx=440; else if(hmode==='fixed') hpx = clamp(Number(state.widgetFixedH[id]||320), 180, 900);
  if (hmode!=='auto'){ el.style.maxHeight = hpx+'px'; el.style.overflow='auto'; }
  return el;
}
function addWidgetControls(wrapper, id, orderKey){
  const size = state.widgetSize[id] || 1;
  const hmode = state.widgetHeightMode[id] || 'auto';
  const row=h('div',{style:'display:flex;gap:8px;justify-content:flex-end;margin-bottom:6px;align-items:center;'},
    h('div',{class:'sizepick'},
      ...[1,2,3].map(n=> h('button',{'aria-pressed': String(size===n), onclick:()=>{ state.widgetSize[id]=n; save(); wrapper.style.gridColumn='span '+n; }}, String(n)))
    ),
    h('div',{class:'field',style:'width:160px;'}, h('label',null,'Height'),
      h('select',{onchange:e=>{ state.widgetHeightMode[id]=e.target.value; save(); render(); }},
        ...[['auto','Auto'],['short','Short'],['medium','Medium'],['tall','Tall'],['fixed','Fixed px']].map(([v,l])=> h('option',{value:v, selected: hmode===v?'selected':null}, l))
      )
    ),
    h('div',{class:'field',style:'width:110px;'+(hmode==='fixed'?'':'display:none;')}, h('label',null,'Pixels'),
      h('input',{type:'number',value:String(state.widgetFixedH[id]||320),oninput:e=>{ state.widgetFixedH[id]=e.target.value; save(); render(); }})
     ),
      h('button',{class:'btn tiny',onclick:()=> configureWidget(id)},'Configure'),
      h('button',{class:'btn tiny',onclick:()=>{ state[orderKey]=state[orderKey].filter(x=>x!==id); save(); render(); }},'Remove')
  );
  wrapper.prepend(row);
}
function enableDrag(container, orderKey){
  const grid = typeof container==='string'? document.getElementById(container) : container;
  if (!grid) return;
  let dragging=null, placeholder=null;
  function onDragStart(e){ const el=e.currentTarget; dragging=el; el.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; placeholder=document.createElement('div'); placeholder.className='placeholder'; placeholder.style.gridColumn=el.style.gridColumn||'span 1'; el.after(placeholder); }
  function onDragOver(e){ e.preventDefault(); const target=e.target.closest('[data-widget-id]'); if(!target || target===dragging || !grid.contains(target)) return; const rect=target.getBoundingClientRect(); const before = (e.clientY-rect.top) < rect.height/2; before ? grid.insertBefore(placeholder, target) : grid.insertBefore(placeholder, target.nextSibling); }
  function onDrop(e){ e.preventDefault(); if(!placeholder||!dragging) return; placeholder.replaceWith(dragging); dragging.classList.remove('dragging'); dragging=null; placeholder=null; persist(); }
  function onDragEnd(){ if(placeholder && dragging){ placeholder.replaceWith(dragging); } dragging?.classList.remove('dragging'); dragging=null; placeholder=null; persist(); }
  function persist(){ const ids=$$('#'+grid.id+' > [data-widget-id]').map(x=>x.getAttribute('data-widget-id')); state[orderKey]=ids; save(); }
  $$('#'+grid.id+' > [data-widget-id]').forEach(el=>{
    el.addEventListener('dragstart', onDragStart); el.addEventListener('dragover', onDragOver); el.addEventListener('drop', onDrop); el.addEventListener('dragend', onDragEnd);
  });
}
/* ---------- Configure modal ---------- */
function showModal(title, contentBuilder, onSave){
  const scrim=h('div',{style:'position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center;z-index:10000;'});
  const card=h('div',{class:'panel p4',style:'width:680px;max-width:94vw;'});
  card.appendChild(h('div',{class:'title'}, title));
  const body=h('div'); card.appendChild(body);
  const row=h('div',{style:'display:flex;justify-content:flex-end;gap:8px;margin-top:10px;'});
  row.appendChild(h('button',{class:'btn tiny',onclick:()=>scrim.remove()},'Cancel'));
  row.appendChild(h('button',{class:'btn tiny primary',onclick:()=>{ onSave&&onSave(); scrim.remove(); render(); }},'Save'));
  card.appendChild(row); scrim.appendChild(card); document.body.appendChild(scrim);
  contentBuilder(body);
  return scrim;
}
function configureWidget(id){
  const cfg = Object.assign({}, getCfg(id));
  showModal('Configure widget', (wrap)=>{
    wrap.appendChild(h('div',{class:'grid grid-2'},
      (function(){ const f=h('div',{class:'field'}, h('label',null,'Chart type'));
        const sel=h('select',{onchange:e=>cfg.chartType=e.target.value},
          ...['auto','line','bar','pie'].map(v=>h('option',{value:v,selected:cfg.chartType===v?'selected':null},v)));
        f.appendChild(sel); return f; })(),
      (function(){ const f=h('div',{class:'field'}, h('label',null,'Series color'));
        f.appendChild(h('input',{type:'color', value: cfg.color || '#3b82f6', oninput:e=>cfg.color=e.target.value}));
        return f; })(),
      (function(){ const f=h('div',{class:'field'}, h('label',null,'Palette'));
        const sel=h('select',{onchange:e=>cfg.palette=e.target.value},
          h('option',{value:'card',selected:cfg.palette==='card'?'selected':null},'Use card colors'),
          h('option',{value:'mono',selected:cfg.palette==='mono'?'selected':null},'Single color'));
        f.appendChild(sel); return f; })(),
      (function(){ const f=h('div',{class:'field'}, h('label',null,'Y min'));
        f.appendChild(h('input',{type:'number',value:cfg.yMin??'',oninput:e=>cfg.yMin=e.target.value===''?null:Number(e.target.value)}));
        return f; })(),
      (function(){ const f=h('div',{class:'field'}, h('label',null,'Y max'));
        f.appendChild(h('input',{type:'number',value:cfg.yMax??'',oninput:e=>cfg.yMax=e.target.value===''?null:Number(e.target.value)}));
        return f; })(),
      (function(){ const f=h('div',{class:'field'}, h('label',null,'From date'));
        f.appendChild(h('input',{type:'date',value:cfg.from||'',oninput:e=>cfg.from=e.target.value})); return f; })(),
      (function(){ const f=h('div',{class:'field'}, h('label',null,'To date'));
        f.appendChild(h('input',{type:'date',value:cfg.to||'',oninput:e=>cfg.to=e.target.value})); return f; })(),
      (function(){ const f=h('div',{class:'field'}, h('label',null,'Group by (subtotals)'));
        const sel=h('select',{onchange:e=>cfg.groupBy=e.target.value},
          h('option',{value:'',selected:!cfg.groupBy?'selected':null},'None'),
          h('option',{value:'issuer',selected:cfg.groupBy==='issuer'?'selected':null},'Issuer')
        ); f.appendChild(sel); return f; })()
    ));
  }, ()=> setCfg(id, cfg));
}

/* ---------- App chrome ---------- */
function appSidebar(){
  const collapsed = !!state.ui.sidebarCollapsed;
  const item=(id, icon, label)=> h('div',{class:'item '+(state.section===id?'active':''), onclick:()=>{ state.section=id; save(); render(); }},
    h('span',{class:'icon'}, icon), collapsed? null : h('span',null,label)
  );
  const themeSwitch = h('div',{class:'switch '+(state.theme==='dark'?'on':''), onclick:()=>{ state.theme = state.theme==='dark'?'light':'dark'; save(); render(); }},
    h('div',{class:'knob'})
  );
  const arrow = collapsed ? 'â–¶' : 'â—€';
  const logoStyle = state.logoData ? `background-image:url(${state.logoData}); background-size:cover;` : '';
  return h('aside',{class:'sidebar'},
    h('div',{class:'brand'},
      h('div',{class:'logo', style:logoStyle}),
      collapsed? null : h('div',{class:'title'}, state.company || 'Company Finance'),
      h('button',{class:'collapse-btn',title: collapsed?'Expand sidebar':'Collapse sidebar', onclick:(e)=>{ e.stopPropagation(); state.ui.sidebarCollapsed=!collapsed; save(); render(); }}, arrow)
    ),
    h('nav',{class:'nav'},
      item('overview','ðŸ ','Overview'),
      item('credit','ðŸ’³','Credit Cards'),
      item('financials','ðŸ¦','Financials'),
      item('settings','âš™ï¸','Settings')
    ),
    h('div',{class:'spacer'}),
    h('div',{class:'foot'},
      collapsed? h('div',{class:'muted',style:'text-align:center;'}, state.theme==='dark'?'ðŸŒ™':'â˜€ï¸') :
        h('div',{class:'muted'}, 'Theme'),
      themeSwitch
    )
  );
}
function appHeader(){
  return h('div',{class:'header'},
    h('div',null, h('h1',null, (state.company||'Company Finance')),
      h('div',{class:'muted'}, 'Stable dashboards â€¢ debounced branding â€¢ more settings')),
    h('div',{style:'display:flex;gap:8px;align-items:center;'},
      h('label',{class:'btn'}, 'Import JSON',
        h('input',{type:'file',accept:'application/json',style:'display:none;',onchange:(e)=>{
          const f=e.target.files&&e.target.files[0]; if(!f) return;
          const reader=new FileReader(); reader.onload=ev=>{
            try{ const data=JSON.parse(String(ev.target.result||'{}')); Object.assign(state, seed(), data); save(); render(); showToast('Import complete','State loaded.'); }
            catch(err){ alert('Import failed: '+err.message); }
          }; reader.readAsText(f);
        }})
      ),
      h('button',{class:'btn',onclick:()=>{
        const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=(state.company||'company')+'-finance-export-'+todayISO()+'.json'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
      }}, 'Export JSON'),
      h('button',{class:'btn tiny',onclick:()=>hardRepair()}, 'Repair')
    )
  );
}

/* ---------- Section chrome ---------- */
function controlsRow(dash, orderKey){
  return h('div',{style:'display:flex;gap:8px;margin:8px 0;'}, 
    h('button',{class:'btn tiny',onclick:()=>{ state.ui.customizing = (state.ui.customizing===dash? null : dash); save(); render(); }}, state.ui.customizing===dash?'Done':'Customize')
  );
}
function customizeBar(dash, orderKey, gridId){
  const idsAvailable = availableForDashboard(dash);
  const idsSelected = (state[orderKey]||[]).filter(id=> idsAvailable.includes(id));
  const bar = h('div',{class:'customise-bar'},
    h('div',{style:'display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;'},
      h('div',null, h('strong',null,'Customize: '), h('span',{class:'muted'}, dash.charAt(0).toUpperCase()+dash.slice(1))),
      h('div',{style:'display:flex;gap:8px;align-items:center;'},
        h('div',null, h('div',{class:'muted'},'Center column weight'),
          h('input',{type:'range',min:'1.3',max:'1.8',step:'0.1',value:String(state.ui.centerWeight||1.6),oninput:e=>{ state.ui.centerWeight=Number(e.target.value); save(); applyThemeTokens(); }})
        ),
        h('button',{class:'btn tiny',onclick:()=>{ state[orderKey] = availableForDashboard(dash).slice(); save(); render(); showToast('Reset','Widget list restored for '+dash+'.'); }},'Reset')
      )
    ),
    h('div',{style:'display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;'}, 
      ...idsAvailable.map(id=>{
        const chosen = idsSelected.includes(id);
        const label = (WidgetRegistry && WidgetRegistry[id] && WidgetRegistry[id].label) ? WidgetRegistry[id].label : id;
        const chip = h('span',{class:'chip'},
          h('span',null, label),
          chosen ? h('button',{onclick:()=>{ state[orderKey]=state[orderKey].filter(x=>x!==id); save(); render(); }}, 'âœ•') :
                   h('button',{onclick:()=>{ if(!state[orderKey].includes(id)) state[orderKey].push(id); save(); render(); }}, '+')
        );
        return chip;
      })
    )
  );
  return bar;
}
function safeSection(title, builder, repair){
  try{ return builder(); }catch(err){
    console.error(err);
    return h('div',{class:'panel p4'},
      sectionTitle(title+' (recovered)'),
      h('div',{class:'muted'}, 'We caught an error while rendering this area: '+err.message),
      h('div',null, h('button',{class:'btn tiny',onclick:()=> render()}, 'Retry render'),
        h('button',{class:'btn tiny',onclick:()=>{ repair&&repair(); }}, 'Repair '+title))
    );
  }
}
function availableForDashboard(d){
  if(d==='overview') return ['ov_finKpis','ov_ccLine','ov_netLine'];
  if(d==='credit') return ['cc_cardsGrid','cc_kpis','cc_line','cc_availLine','cc_remainLine','cc_bar','cc_remainBar','cc_dueSoon','cc_utilLadder','cc_changedToday','cc_payCalendar','cc_agingBuckets','cc_exposureIssuer'];
  if(d==='financials') return ['fin_kpis','fin_cashLine','fin_debtLine','fin_netLine','fin_upcoming'];
  return [];
}

/* ----- Credit Cards widgets & pages ----- */
function fieldBlock(label, value, highlight=false){ return h('div',null, h('div',{class:'muted'},label), h('div',{style:'font-weight:600;'+(highlight?'color:#B42318;':'')}, value)); }
function ccCardsGridWidget(){
  const latest=latestByCard();
  return [sectionTitle('Cards Overview'),
    h('div',{class:'grid grid-2'}, ...state.cards.map(card=>{
      const last=latest[card.id]||{};
      const util=(card.limit && last?.totalBalance!=null)?(Number(last.totalBalance)/Number(card.limit)):null;
      const daysTilDue=last?.dueDate?daysBetween(todayISO(), last.dueDate):null;
      const closesIn=last?.statementEnd?daysBetween(todayISO(), last.statementEnd):null;
      const estInterest = card.apr && last?.totalBalance!=null ? (Number(card.apr)/100/12)*Number(last.totalBalance) : null;
      const overLimit=last?.overLimit||0;
      const {r,g,b}=hexToRgb(card.color||'#3b82f6');
      const bg = card.useGradient!==false ? `linear-gradient(180deg, rgba(${r},${g},${b},${(state.ui.gradientAlpha??.06)}) 0%, rgba(${r},${g},${b},0.00) 100%)` : 'var(--panel)';
      const baseStyle = `border-color:${card.color||'#3b82f6'}; background:${bg}`;
      const overTarget = card.utilTarget!=null && util!=null ? ((util*100)>=Number(card.utilTarget)) : false;
      const cardBox=h('div',{class:'card',style:baseStyle},
        overLimit>0? h('div',{class:'badge bad'}, 'Over by '+fmtUSD(overLimit)) : (overTarget? h('div',{class:'badge warn'}, 'â‰¥ Target '+card.utilTarget+'%') : null),
        h('div',{style:'display:flex;justify-content:space-between;align-items:center;gap:8px;'},
          h('div',null, h('div',{style:'font-weight:700;font-size:16px;'}, card.name),
            h('div',{class:'muted'}, (card.issuer||'Issuer')+' â€¢ Limit: '+(card.limit?fmtUSD(card.limit):'(set limit)'))),
          h('div',null, h('button',{class:'btn tiny',onclick:()=>{ state.ccView='log'; state.selectedCardId=card.id; save(); render(); }}, 'Log'))
        ),
        h('div',{class:'grid grid-2',style:'margin-top:8px;'},
          fieldBlock(''+(card.issuer==='Chase'?'Current Balance':'Total Balance'), fmtUSD(last?.totalBalance)),
          fieldBlock('Remaining Statement Balance', fmtUSD(last?.amountDue)),
          fieldBlock('Min Payment', fmtUSD(last?.minPayment)),
          fieldBlock('Available', fmtUSD(last?.availableCredit)),
          fieldBlock('Over Limit', last?.overLimit? fmtUSD(last.overLimit) : 'â€”', (last?.overLimit||0)>0),
          fieldBlock('Utilization', util!=null ? (util*100).toFixed(1)+'%' : 'â€”', util!=null && util>=0.9),
          fieldBlock('Util Target', card.utilTarget!=null ? (card.utilTarget+'%') : 'â€”'),
          fieldBlock('Due Date', last?.dueDate || 'â€”'),
          fieldBlock('Days till Due', daysTilDue != null? String(daysTilDue) : 'â€”', daysTilDue != null && daysTilDue<=5),
          fieldBlock('Statement Close', last?.statementEnd||'â€”'),
          fieldBlock('Closes in', closesIn != null? String(closesIn) : 'â€”', closesIn != null && closesIn<=3),
          fieldBlock('Est. Interest (mo)', estInterest!=null? fmtUSD(estInterest) : 'â€”')
        )
      );
      return cardBox;
    }))
  ];
}
function colorPickerField(label, current, onHexChange){
  const palette=['#3b82f6','#0ea5e9','#10b981','#f59e0b','#ef4444','#a855f7','#14b8a6','#f97316','#64748b','#22c55e','#e11d48'];
  const container=h('div',{class:'field'}, h('label',null,label),
    h('div',{style:'display:flex;gap:8px;align-items:center;flex-wrap:wrap;'},
      h('input',{type:'color', value: current||'#3b82f6', oninput:e=>{ onHexChange(e.target.value); }}),
      h('input',{type:'text', value: current||'#3b82f6', oninput:e=>onHexChange(e.target.value)}),
      h('div',{class:'palette'}, ...palette.map(hex=> h('div',{class:'swatch',style:'background:'+hex, onclick:()=>{ onHexChange(hex); render(); }})))
    )
  );
  return container;
}
function ccCards(){
  const grid=h('div',{class:'grid grid-1',style:'margin-top:10px;'});
  const addBtn = h('button',{class:'btn primary',onclick:()=>{
    state.cards.push({id:uid(),name:'New Card '+(state.cards.length+1),issuer:'Chase',limit:null,apr:null,fixedDueDay:12,fixedCloseDay:15,color:'#3b82f6',utilTarget:30,useGradient:true});
    bump('cards'); save(); render();
  }}, 'Add Card');
  grid.appendChild(h('div',null, addBtn));
  state.cards.forEach(card=>{
    grid.appendChild(h('div',{class:'panel p4'},
      sectionTitle(card.name+' â€” Settings'),
      h('div',{class:'grid grid-3'},
        fieldInput('Card Name', card.name, v=>{card.name=v; save();}),
        h('div',{class:'field'}, h('label',null,'Issuer'),
          h('select',{onchange:e=>{card.issuer=e.target.value; save(); render();}},
            ...['Chase','AmEx','Other'].map(x=> h('option',{value:x, selected:card.issuer===x?'selected':null}, x))
          )
        ),
        (function(){ const w=h('div'); w.appendChild(currencyInput(card.limit==null?'':card.limit, v=>{card.limit=asNumber(v); save();}, 'Credit Limit')); return w; })(),
        (function(){ const w=h('div'); w.appendChild(percentInput(card.apr==null?'':card.apr, v=>{card.apr=v===''?null:Number(v); save();}, 'APR %')); return w; })(),
        colorPickerField('Card Color', card.color||'#3b82f6', hex=>{ card.color=hex; save(); }),
        fieldInput('Utilization Target %', card.utilTarget??'', v=>{card.utilTarget=v===''?null:Number(v); save();}),
        h('div',{class:'field'}, h('label',null,'Use Gradient?'),
          h('select',{onchange:e=>{ card.useGradient=e.target.value==='yes'; save(); render(); }},
            h('option',{value:'yes', selected:card.useGradient!==false?'selected':null}, 'Yes'),
            h('option',{value:'no', selected:card.useGradient===false?'selected':null}, 'No')
          )
        ),
        ...(card.issuer==='Chase' ? [
          fieldInput('Fixed Due Day (1â€“28)', card.fixedDueDay??12, v=>{card.fixedDueDay=clampDay(v); save();}),
          fieldInput('Fixed Close Day (1â€“28)', card.fixedCloseDay??15, v=>{card.fixedCloseDay=clampDay(v); save();}),
        ]:[])
      ),
      h('div',{style:'display:flex;justify-content:flex-end;gap:8px;'},
        h('button',{class:'btn tiny',onclick:()=>{ if(confirm('Delete this card and all its entries?')){ state.cards=state.cards.filter(c=>c.id!==card.id); state.entries=state.entries.filter(e=>e.cardId!==card.id); bump('cards'); bump('entries'); save(); render(); } }}, 'Delete')
      )
    ));
  });
  return grid;
}
function ccLog(){
  const selected = state.cards.find(c=>c.id===state.selectedCardId) || state.cards[0] || null;
  const draft = state.ui.ccDraft = state.ui.ccDraft||{ date: todayISO(), totalBalance:'', amountDue:'', minPayment:'', availableCredit:'', overLimit:'', statementEnd:'', dueDate:'', notes:'' };
  draft.date = draft.date || todayISO();
  const labels = (!selected || selected.issuer!=='Chase') ?
    { total:'Total Balance', amount:'Remaining Statement Balance', avail:'Available Credit' } :
    { total:'Current Balance', amount:'Remaining Statement Balance', avail:'Available Credit' };
  function lastEntry(cardId){ const list=state.entries.filter(e=>e.cardId===cardId).sort((a,b)=>b.date.localeCompare(a.date)); return list[0]||null; }
  function suggestDue(){ if(!selected) return; if(selected.issuer==='Chase'){ return nextMonthlyDateFrom(selected.fixedDueDay||12, draft.date); } const last=lastEntry(selected.id); if(last?.dueDate) return last.dueDate; return draft.dueDate||todayISO(); }
  function suggestClose(){ if(!selected) return; if(selected.issuer==='Chase'){ return nextMonthlyDateFrom(selected.fixedCloseDay||15, draft.date); } const last=lastEntry(selected.id); if(last?.statementEnd) return last.statementEnd; return draft.statementEnd||todayISO(); }
  const form = h('div',{class:'panel p4',style:'margin-top:10px;'},
    sectionTitle('Log Daily Entry'),
    h('div',{class:'field'}, h('label',null,'Card'),
      h('select',{onchange:e=>{ state.selectedCardId=e.target.value; save(); render(); }},
        ...state.cards.map(c=> h('option',{value:c.id, selected:(selected&&selected.id===c.id)?'selected':null}, c.name))
      )
    ),
    h('div',{class:'grid grid-2'},
      fieldInput('Date', draft.date, v=>draft.date=v, 'date'),
      h('div',null, h('div',{style:'display:flex;gap:6px; align-items:end;'},
        fieldInput('Due Date', draft.dueDate||'', v=>draft.dueDate=v, 'date'),
        h('button',{class:'btn tiny',title:'Suggest next due date',onclick:()=>{ draft.dueDate=suggestDue(); render(); }},'Suggest')
      )),
      currencyInput(draft.totalBalance, v=>draft.totalBalance=v, labels.total),
      currencyInput(draft.amountDue, v=>draft.amountDue=v, 'Remaining Statement Balance'),
      currencyInput(draft.availableCredit, v=>{
        draft.availableCredit=v;
        if (selected && selected.issuer==='Chase' && Number(String(v).replace(/,/g,''))===0){
          const tb = Number(String(draft.totalBalance||'').replace(/,/g,''))||0;
          const lim = Number(selected.limit)||0;
          const over = Math.max(0, tb - lim);
          draft.overLimit = over? String(over) : '';
          render();
        }
      }, labels.avail),
      h('div',null, h('div',{style:'display:flex;gap:6px; align-items:end;'},
        fieldInput('Statement End', draft.statementEnd||'', v=>draft.statementEnd=v, 'date'),
        h('button',{class:'btn tiny',title:'Suggest close date',onclick:()=>{ draft.statementEnd=suggestClose(); render(); }},'Suggest')
      )),
      currencyInput(draft.minPayment, v=> draft.minPayment=v, 'Minimum Payment'),
      currencyInput(draft.overLimit, v=> draft.overLimit=v, 'Over Limit (if any)')
    ),
    h('div',{class:'field'}, h('label',null,'Notes'), h('textarea',{rows:3,oninput:e=>draft.notes=e.target.value,value:draft.notes||''})),
    h('div',null,
      h('button',{class:'btn primary',onclick:()=>{
        if (!selected){ alert('Select or create a card first.'); return; }
        const overLimit=(draft.availableCredit!=='' && asNumber(draft.availableCredit)<=0) ? (draft.overLimit===''? null : asNumber(draft.overLimit)) : null;
        const e={id:uid(),cardId:selected.id,date:draft.date,totalBalance:asNumber(draft.totalBalance),amountDue:asNumber(draft.amountDue),minPayment:asNumber(draft.minPayment),availableCredit:asNumber(draft.availableCredit),overLimit,statementEnd:draft.statementEnd||null,dueDate:draft.dueDate||null,notes:draft.notes||''};
        state.entries.push(e); bump('entries'); save();
        Object.assign(draft,{ totalBalance:'', amountDue:'', minPayment:'', availableCredit:'', overLimit:'', notes:'' }); render();
      }}, 'Save Entry'),
      h('button',{class:'btn',onclick:()=>{ Object.assign(draft,{ date: todayISO(), totalBalance:'', amountDue:'', minPayment:'', availableCredit:'', overLimit:'', statementEnd:'', dueDate:'', notes:'' }); render(); }}, 'Clear')
    )
  );
  const histFilter = state.ui.histFilter || {mode:'selected', from:'', to:''}; state.ui.histFilter=histFilter;
  const historyList=(function(){ let list=state.entries.slice(); if(histFilter.mode!=='all' && selected) list=list.filter(e=>e.cardId===selected.id); if(histFilter.from) list=list.filter(e=>e.date>=histFilter.from); if(histFilter.to) list=list.filter(e=>e.date<=histFilter.to); return list; })();
  const hist = h('div',{class:'panel p4',style:'margin-top:10px;'},
    sectionTitle('History'),
    h('div',{style:'display:flex;gap:8px;align-items:end;flex-wrap:wrap;'},
      h('div',{class:'field'}, h('label',null,'Show'),
        h('select',{onchange:e=>{ histFilter.mode=e.target.value; render(); }},
          h('option',{value:'selected', selected: histFilter.mode==='selected'?'selected':null}, 'Selected card'),
          h('option',{value:'all', selected: histFilter.mode==='all'?'selected':null}, 'All cards')
        )
      ),
      fieldInput('From', histFilter.from||'', v=>{ histFilter.from=v; }, 'date'),
      fieldInput('To', histFilter.to||'', v=>{ histFilter.to=v; }, 'date'),
      h('button',{class:'btn tiny',onclick:()=> render()},'Apply')
    ),
    pagedHistory(historyList, 200, (e)=>{
      const c=state.cards.find(x=>x.id===e.cardId);
      return h('tr',null,
        h('td',null, e.date),
        h('td',null, c?.name||'â€”'),
        h('td',null, fmtUSD(e.totalBalance)),
        h('td',null, fmtUSD(e.amountDue)),
        h('td',null, fmtUSD(e.minPayment)),
        h('td',null, fmtUSD(e.availableCredit)),
        h('td',null, (e.statementEnd||'â€”')),
        h('td',null, (e.dueDate||'â€”')),
        h('td',null, h('div',{title:e.notes,style:'max-width:360px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;'}, e.notes||'')),
        h('td',null, h('button',{class:'btn tiny',onclick:()=>{ state.entries=state.entries.filter(x=>x.id!==e.id); bump('entries'); save(); render(); }}, 'Delete'))
      );
    })
  );
  const container=h('div',null, form, hist); return container;
}
function pagedHistory(list,pageSize,rowBuilder){
  const sorted=list.slice().sort((a,b)=>b.date.localeCompare(a.date));
  let shown=Math.min(sorted.length,pageSize);
  const wrap=h('div',{style:'overflow:auto;margin-top:8px;'});
  const table=h('table',{class:'table'}, h('thead',null,h('tr',null, ...['Date','Card','Total','Remaining','Min Pay','Available','Statement','Due Date','Notes',''].map(th=>h('th',null,th)))), h('tbody',{id:'ph-body'}));
  wrap.appendChild(table);
  function renderRows(n){ const tbody=table.querySelector('#ph-body'); for(let i=tbody.children.length;i<n;i++){ const e=sorted[i]; if(!e) break; tbody.appendChild(rowBuilder(e)); } }
  renderRows(shown);
  if(shown<sorted.length){ const more=h('div',{style:'display:flex;justify-content:center;margin-top:8px;'}, h('button',{class:'btn',onclick:()=>{ shown=Math.min(sorted.length,shown+pageSize); renderRows(shown); }}, `Load more (${sorted.length-shown} remaining)`)); wrap.appendChild(more); }
  return wrap;
}

/* ----- Financials ----- */
function seriesFrom(pred){ const m=new Map(); for(const e of state.finEntries){ if(!pred(e)) continue; m.set(e.date,(m.get(e.date)||0)+(Number(e.balance)||0)); } return Array.from(m.entries()).sort((a,b)=>a[0].localeCompare(b[0])).map(([date,y])=>({date,y})); }
function finAccounts(){
  const grid=h('div',{class:'grid grid-1',style:'margin-top:10px;'});
  const addRow=h('div',null,
    h('button',{class:'btn primary',onclick:()=>{ state.finAccounts.push({id:uid(),name:'New Bank Account',bank:'',number:'',type:'bank',color:'#14b8a6'}); bump('finAccounts'); save(); render(); }},'Add Bank'),
    ' ',
    h('button',{class:'btn',onclick:()=>{ state.finAccounts.push({id:uid(),name:'New Loan',bank:'',number:'',type:'loan',color:'#f97316',apr:6.00}); bump('finAccounts'); save(); render(); }},'Add Loan')
  );
  grid.appendChild(addRow);
  state.finAccounts.forEach(a=>{
    grid.appendChild(h('div',{class:'panel p4'},
      sectionTitle(a.name+' â€” '+(a.type==='bank'?'Bank':'Loan')),
      h('div',{class:'grid grid-3'},
        fieldInput('Name', a.name, v=>{a.name=v; save();}),
        fieldInput(a.type==='bank'?'Bank':'Lender', a.bank||'', v=>{a.bank=v; save();}),
        fieldInput('Identifier', a.number||'', v=>{a.number=v; save();}),
        colorPickerField('Color', a.color||'#14b8a6', hex=>{ a.color=hex; save(); }),
        ...(a.type==='loan'? [percentInput(a.apr==null?'':a.apr, v=>{a.apr=v===''?null:Number(v); save();}, 'APR %')] : [])
      ),
      h('div',{style:'display:flex;justify-content:flex-end;gap:8px;'},
        h('button',{class:'btn tiny',onclick:()=>{ if(confirm('Delete this account and its entries?')){ state.finAccounts=state.finAccounts.filter(x=>x.id!==a.id); state.finEntries=state.finEntries.filter(e=>e.accountId!==a.id); state.finExpenses=state.finExpenses.filter(x=>x.accountId!==a.id); bump('finAccounts'); bump('finEntries'); save(); render(); } }}, 'Delete')
      )
    ));
  });
  return grid;
}
function finLog(){
  const d = state.ui.finDraft = state.ui.finDraft||{ accountId:'', date: todayISO(), balance:'', inflow:'', outflow:'' , notes:'' };
  const left=h('div',{class:'panel p4',style:'margin-top:10px;'},
    sectionTitle('Daily Account Log'),
    h('div',{class:'field'}, h('label',null,'Account'),
      h('select',{onchange:e=>{ d.accountId=e.target.value; }},
        h('option',{value:''},'â€” Select â€”'),
        ...state.finAccounts.map(a=> h('option',{value:a.id, selected:d.accountId===a.id?'selected':null}, a.name))
      )
    ),
    h('div',{class:'grid grid-2'},
      fieldInput('Date', d.date, v=>d.date=v, 'date'),
      currencyInput(d.balance, v=>d.balance=v, 'Balance'),
      currencyInput(d.inflow, v=>d.inflow=v, 'Inflow (optional)'),
      currencyInput(d.outflow, v=>d.outflow=v, 'Outflow (optional)')
    ),
    h('div',{class:'field'}, h('label',null,'Notes'), h('textarea',{rows:3,oninput:e=>d.notes=e.target.value,value:d.notes||''})),
    h('div',null,
      h('button',{class:'btn primary',onclick:()=>{
        const acc = getAcc(d.accountId); if(!acc){ alert('Select an account'); return; }
        state.finEntries.push({id:uid(),accountId:acc.id,date:d.date,balance:asNumber(d.balance),inflow:asNumber(d.inflow),outflow:asNumber(d.outflow),notes:d.notes||''});
        bump('finEntries'); save(); render(); Object.assign(d,{balance:'',inflow:'',outflow:'',notes:''});
      }}, 'Save Entry'),
      h('button',{class:'btn',onclick:()=>{ Object.assign(d,{ accountId:'', date: todayISO(), balance:'', inflow:'', outflow:'', notes:'' }); render(); }}, 'Clear')
    )
  );
  const right=h('div',{class:'panel p4',style:'margin-top:10px;'}, sectionTitle('History'),
    pagedHistory(state.finEntries, 200, (e)=>{
      const a=getAcc(e.accountId);
      return h('tr',null,
        h('td',null,e.date), h('td',null,a?.name||'â€”'), h('td',null,fmtUSD(e.balance)), h('td',null,fmtUSD(e.inflow)), h('td',null,fmtUSD(e.outflow)),
        h('td',null,h('div',{title:e.notes,style:'max-width:360px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;'},e.notes||'')),
        h('td',null,h('button',{class:'btn tiny',onclick:()=>{ state.finEntries=state.finEntries.filter(x=>x.id!==e.id); bump('finEntries'); save(); render(); }},'Delete'))
      );
    })
  );
  return h('div',null,left,right);
}
function FinUpcomingWidget(){
  const now=new Date(); now.setHours(0,0,0,0); const week=new Date(now); week.setDate(week.getDate()+7);
  const upcoming = state.finExpenses.filter(x=>{ const d=new Date(x.date); d.setHours(0,0,0,0); return d>=now && d<=week && !x.paid; }).sort((a,b)=>a.date.localeCompare(b.date));
  const list=h('div',null, sectionTitle('Upcoming Expenses (7 days)'));
  if(!upcoming.length){ list.appendChild(h('div',{class:'muted'},'No upcoming expenses logged. Add items in the "Expenses (7d)" tab.')); return list; }
  upcoming.forEach(x=>{ const acc=getAcc(x.accountId);
    list.appendChild(h('div',{style:'display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;background:var(--panel-2);border:1px solid var(--border);padding:8px 12px;border-radius:10px;'},
      h('div',{class:'muted'}, `${x.date} â€¢ ${x.desc||'Expense'} â€¢ ${acc?.name||'â€”'}`),
      h('div',{style:'font-weight:700;'}, fmtUSD(Number(x.amount)||0))
    ));
  });
  return list;
}
function finUpcoming(){
  const grid=h('div',{class:'grid grid-1',style:'margin-top:10px;'});
  const list=h('div',{class:'panel p4'}, sectionTitle('Upcoming Expenses (7 days)'));
  const wrap=h('div',null);
  const d={ accountId:'', date: todayISO(), amount:'', desc:'', paid:false };
  const form=h('div',{class:'panel p4'}, sectionTitle('Add Expense'),
    h('div',{class:'grid grid-3'},
      h('div',{class:'field'}, h('label',null,'Account'),
        h('select',{onchange:e=>{ d.accountId=e.target.value; }},
          h('option',{value:''},'â€” Select â€”'),
          ...state.finAccounts.map(a=> h('option',{value:a.id}, a.name))
        )
      ),
      fieldInput('Date', d.date, v=>d.date=v, 'date'),
      currencyInput(d.amount, v=>d.amount=v, 'Amount'),
      fieldInput('Description', d.desc, v=>d.desc=v),
      h('div',{class:'field'}, h('label',null,'Paid?'),
        h('select',{onchange:e=>{ d.paid = e.target.value==='yes'; }},
          h('option',{value:'no'},'No'), h('option',{value:'yes'},'Yes')
        )
      )
    ),
    h('div',null, h('button',{class:'btn primary',onclick:()=>{
      if(!d.accountId){ alert('Select an account'); return; }
      state.finExpenses.push({id:uid(), accountId:d.accountId, date:d.date, amount:asNumber(d.amount), desc:d.desc||'', paid:!!d.paid}); save(); render();
    }},'Add Expense'))
  );
  const now=new Date(); now.setHours(0,0,0,0); const week=new Date(now); week.setDate(week.getDate()+7);
  const upcoming=state.finExpenses.filter(x=>{ const dt=new Date(x.date); dt.setHours(0,0,0,0); return dt>=now && dt<=week; }).sort((a,b)=>a.date.localeCompare(b.date));
  const tbl=h('table',{class:'table'}, h('thead',null,h('tr',null, ...['Date','Account','Amount','Description','Paid',''].map(th=>h('th',null,th)))),
    h('tbody',null, ...upcoming.map(x=>{
      const acc=getAcc(x.accountId);
      return h('tr',null, h('td',null,x.date), h('td',null,acc?.name||'â€”'), h('td',null,fmtUSD(x.amount)), h('td',null,x.desc||''), h('td',null,x.paid?'Yes':'No'),
        h('td',null,h('button',{class:'btn tiny',onclick:()=>{ state.finExpenses=state.finExpenses.filter(e=>e.id!==x.id); save(); render(); }},'Delete'))
      );
    }))
  );
  list.appendChild(tbl); wrap.appendChild(form); wrap.appendChild(list); grid.appendChild(wrap); return grid;
}

/* ----- Widgets registry (populate AFTER helpers defined) ----- */
Object.assign(WidgetRegistry, {
  ov_finKpis:{label:'Financial KPIs', size:2, build:()=>[sectionTitle('Financial KPIs'), h('div',{class:'grid grid-2'}, kpi('Cash (banks)', fmtUSD(finKPIs().cash)), kpi('Debt (loans)', fmtUSD(finKPIs().debt)), kpi('Net (cash - debt)', fmtUSD(finKPIs().net)), kpi('CC Remaining', fmtUSD(kpisCC().totalRemain)))]},
  ov_ccLine:{label:'Total CC Balance Over Time', size:2, build:()=>{
  const id='ov_ccLine', cfg=getCfg(id);
  let s = summedSeries('totalBalance');
  s = filterSeriesByCfg(s, cfg);
  const chart = (cfg.chartType==='bar')
    ? barChart(s.map(p=>({label:p.date,value:p.y})),{yMin:cfg.yMin,yMax:cfg.yMax,currency:true})
    : lineChart(s,{height:160,color:cfg.color,yMin:cfg.yMin,yMax:cfg.yMax});
  return [sectionTitle('Total CC Balance Over Time'), chart];
}},
  ov_netLine:{label:'Net Worth Over Time', size:2, build:()=>[sectionTitle('Net Worth Over Time'), (function(){ const cash=seriesFrom(e=> getAcc(e.accountId)?.type==='bank'); const debt=seriesFrom(e=> getAcc(e.accountId)?.type==='loan'); const map=new Map(); for(const p of cash) map.set(p.date,(map.get(p.date)||0)+Number(p.y||0)); for(const p of debt) map.set(p.date,(map.get(p.date)||0)-Number(p.y||0)); const s=Array.from(map.entries()).sort().map(([date,y])=>({date,y})); return lineChart(s,{height:160}); })()]},
  cc_cardsGrid:{label:'Cards Overview', size:2, build:()=> ccCardsGridWidget()},
  cc_kpis:{label:'CC KPIs', size:1, build:()=>[sectionTitle('KPIs'), (function(){ const ccK=kpisCC(); return h('div',{class:'grid grid-2'}, kpi('Total Balance (latest)', fmtUSD(ccK.totalBalance)), kpi(`Due in â‰¤ 5 days`, fmtUSD(ccK.totalDueSoon)), kpi('Avg Utilization', ccK.avgUtil!=null ? (ccK.avgUtil*100).toFixed(1)+'%':'â€”'), kpi('Total Over Limit', fmtUSD(ccK.totalOverLimit)), kpi('Total Available', fmtUSD(ccK.totalAvail)), kpi('Total Remaining', fmtUSD(ccK.totalRemain))); })()]},
  cc_line:{label:'Total Balance Over Time', size:2, build:()=>[sectionTitle('Total Balance Over Time'), lineChart(summedSeries('totalBalance'),{height:180})]},
  cc_availLine:{label:'Total Available Over Time', size:2, build:()=>[sectionTitle('Total Available Over Time'), lineChart(summedSeries('availableCredit'),{height:180})]},
  cc_remainLine:{label:'Total Remaining Statement Over Time', size:2, build:()=>[sectionTitle('Total Remaining Statement Over Time'), lineChart(summedSeries('amountDue'),{height:180})]},
  cc_bar:{label:'Utilization by Card', size:2, build:()=> (function(){
  const id='cc_bar', cfg=getCfg(id); const latest=latestByCard();
  const cards = filterCardsByCfg(state.cards, cfg);
  const utilItems=cards.map(c=>{
    const last=latest[c.id];
    const util=(c.limit&&last?.totalBalance!=null)?(Number(last.totalBalance)/Number(c.limit)):0;
    return {label:c.name, issuer:c.issuer, value: Math.min(150, Math.round(util*100))};
  });
  const colors = (cfg.palette==='mono') ? utilItems.map(_=> cfg.color||'#3b82f6') : cards.map(c=>c.color||'#3b82f6');
  const chart = (cfg.chartType==='pie') ? pieChart(utilItems,{colors})
               : barChart(utilItems,{colors,valueSuffix:'%',yMin:cfg.yMin,yMax:cfg.yMax});
  const parts=[sectionTitle('Utilization by Card (latest)'), chart];
  if (cfg.groupBy==='issuer'){
    const subs=subtotalBy(utilItems,'issuer','value');
    parts.push(h('table',{class:'table'}, h('thead',null,h('tr',null,h('th',null,'Issuer'),h('th',null,'Subtotal %'))),
      h('tbody',null, ...subs.map(s=>h('tr',null,h('td',null,s.label),h('td',null,(s.value).toFixed(1)+'%'))))));
  }
  return parts;
})()},
  cc_remainBar:{label:'Remaining Statement by Card', size:2, build:()=> (function(){
  const id='cc_remainBar', cfg=getCfg(id); const latest=latestByCard();
  const cards = filterCardsByCfg(state.cards, cfg);
  const remItems=cards.map(c=>({label:c.name, value:Number(latest[c.id]?.amountDue)||0}));
  const colors = (cfg.palette==='mono') ? remItems.map(_=> cfg.color||'#3b82f6') : cards.map(c=>c.color||'#3b82f6');
  const chart = (cfg.chartType==='pie') ? pieChart(remItems,{colors})
               : barChart(remItems,{colors,currency:true,yMin:cfg.yMin,yMax:cfg.yMax});
  return [sectionTitle('Remaining Statement by Card (latest)'), chart];
})()},
  cc_dueSoon:{label:'Due Soon Timeline', size:1, build:()=> DueSoonWidget()},
  cc_utilLadder:{label:'Utilization Order', size:1, build:()=> UtilLadderWidget()},
  cc_changedToday:{label:'What changed today?', size:1, build:()=> ChangedTodayWidget()},
  cc_payCalendar:{label:'Payment Calendar (4 weeks)', size:2, build:()=> PayCalendarWidget()},
  cc_agingBuckets:{label:'Aging Buckets', size:1, build:()=> AgingBucketsWidget()},
  cc_exposureIssuer:{label:'Exposure by Issuer', size:1, build:()=> ExposureIssuerWidget()},
  fin_kpis:{label:'Financial KPIs', size:1, build:()=>[sectionTitle('Financial KPIs'), (function(){ const f=finKPIs(); return h('div',{class:'grid grid-2'}, kpi('Cash',fmtUSD(f.cash)), kpi('Debt',fmtUSD(f.debt)), kpi('Net',fmtUSD(f.net))); })()]},
  fin_cashLine:{label:'Cash Over Time', size:2, build:()=>[sectionTitle('Cash Over Time'), lineChart(seriesFrom(e=> getAcc(e.accountId)?.type==='bank'),{height:160})]},
  fin_debtLine:{label:'Debt Over Time', size:2, build:()=>[sectionTitle('Debt Over Time'), lineChart(seriesFrom(e=> getAcc(e.accountId)?.type==='loan'),{height:160})]},
  fin_netLine:{label:'Net Worth Over Time', size:2, build:()=> (function(){ const cash=seriesFrom(e=> getAcc(e.accountId)?.type==='bank'); const debt=seriesFrom(e=> getAcc(e.accountId)?.type==='loan'); const map=new Map(); for(const p of cash) map.set(p.date,(map.get(p.date)||0)+Number(p.y||0)); for(const p of debt) map.set(p.date,(map.get(p.date)||0)-Number(p.y||0)); const s=Array.from(map.entries()).sort().map(([date,y])=>({date,y})); return [sectionTitle('Net Worth Over Time'), lineChart(s,{height:200})]; })()},
  fin_upcoming:{label:'Upcoming Expenses (7d)', size:1, build:()=> FinUpcomingWidget()}
});

/* ----- Missing widget builders used above ----- */
function DueSoonWidget(){
  const latest=latestByCard(); const now=todayISO();
  const items=state.cards.map(c=>{ const last=latest[c.id]; const d=last?.dueDate? daysBetween(now,last.dueDate):null; return {label:c.name, value: d!=null? Math.max(0, 30-d):0}; });
  return [sectionTitle('Due Soon (progress to 30 days)'), barChart(items,{valueSuffix:' d',colors:state.cards.map(c=>c.color||'#3b82f6')})];
}
function UtilLadderWidget(){
  const id='cc_utilLadder', cfg=getCfg(id);
  const latest=latestByCard();
  let rows=state.cards.map(c=>{
    const last=latest[c.id];
    const util=(c.limit&&last?.totalBalance!=null)?(Number(last.totalBalance)/Number(c.limit)):0;
    return {name:c.name, issuer:c.issuer, util};
  });
  const by = cfg.sort?.by || 'util'; const dir = cfg.sort?.dir || 'desc';
  rows = sortBy(rows, by, dir);
  const thead=h('thead',null,h('tr',null,
    h('th',{onclick:()=>{ setCfg(id,{sort:{by:'name',dir: (by==='name'&&dir==='asc')?'desc':'asc'}}); render(); },style:'cursor:pointer;'}, 'Card'),
    h('th',{onclick:()=>{ setCfg(id,{sort:{by:'util',dir: (by==='util'&&dir==='asc')?'desc':'asc'}}); render(); },style:'cursor:pointer;'}, 'Util')
  ));
  const tbody=h('tbody',null, ...rows.map(r=> h('tr',null, h('td',null,r.name), h('td',null,(r.util*100).toFixed(1)+'%'))));
  return [sectionTitle('Utilization Order'), h('table',{class:'table'}, thead, tbody)];
}
function ChangedTodayWidget(){
  const today=todayISO(); const list=state.entries.filter(e=>e.date===today).sort((a,b)=>a.cardId.localeCompare(b.cardId));
  if(!list.length) return [sectionTitle('What changed today?'), h('div',{class:'muted'},'No entries logged today.')];
  return [sectionTitle('What changed today?'), h('table',{class:'table'}, h('thead',null,h('tr',null, ...['Card','Î” Balance','Î” Remaining','Î” Available'].map(x=>h('th',null,x)))), h('tbody',null, ...list.map(e=>{
    const prev=state.entries.filter(x=>x.cardId===e.cardId && x.date<today).sort((a,b)=>b.date.localeCompare(a.date))[0];
    const c=state.cards.find(x=>x.id===e.cardId);
    const d=(k)=> (Number(e[k]||0) - Number(prev?.[k]||0));
    return h('tr',null, h('td',null,c?.name||'â€”'), h('td',null, fmtUSD(d('totalBalance'))), h('td',null, fmtUSD(d('amountDue'))), h('td',null, fmtUSD(d('availableCredit'))));
  })))];
}
function PayCalendarWidget(){
  const latest=latestByCard(); const now=new Date(); const dates=[]; for(let i=0;i<28;i++){ const d=new Date(now); d.setDate(now.getDate()+i); dates.push(d.toISOString().slice(0,10)); }
  const wrap=h('div',null, sectionTitle('Payment Calendar (next 4 weeks)'), h('div',{class:'cal'}));
  const grid=wrap.lastChild; grid.appendChild(h('div',{class:'dow'},'Sun'));grid.appendChild(h('div',{class:'dow'},'Mon'));grid.appendChild(h('div',{class:'dow'},'Tue'));grid.appendChild(h('div',{class:'dow'},'Wed'));grid.appendChild(h('div',{class:'dow'},'Thu'));grid.appendChild(h('div',{class:'dow'},'Fri'));grid.appendChild(h('div',{class:'dow'},'Sat'));
  dates.forEach(d=>{
    const box=h('div',{class:'cell'}, h('div',{class:'muted'}, d));
    state.cards.forEach(c=>{ const last=latest[c.id]; if(last?.dueDate===d){ const dot=h('span',{class:'dot',style:'background:'+ (c.color||'#3b82f6')}); box.appendChild(h('div',null, dot, ' ', c.name)); } });
    grid.appendChild(box);
  });
  return [wrap];
}
function AgingBucketsWidget(){
  const latest=latestByCard(); const buckets=[{name:'0â€“10', val:0},{name:'11â€“20', val:0},{name:'21â€“30', val:0},{name:'>30', val:0}];
  const now=todayISO();
  state.cards.forEach(c=>{ const last=latest[c.id]; if(!last?.dueDate) return; const d=daysBetween(now,last.dueDate); if(d<=10) buckets[0].val++; else if(d<=20) buckets[1].val++; else if(d<=30) buckets[2].val++; else buckets[3].val++; });
  return [sectionTitle('Aging Buckets (count of cards by days-to-due)'), barChart(buckets.map(b=>({label:b.name, value:b.val})),{})];
}
function ExposureIssuerWidget(){
  const id='cc_exposureIssuer', cfg=getCfg(id);
  const latest=latestByCard(); const map=new Map();
  state.cards.forEach(c=>{ const val=Number(latest[c.id]?.totalBalance)||0; map.set(c.issuer, (map.get(c.issuer)||0)+val); });
  let items=Array.from(map.entries()).map(([label,value])=>({label,value}));
  const chart = (cfg.chartType==='pie') ? pieChart(items,{colors:items.map(_=>cfg.color||'#3b82f6')})
               : barChart(items,{currency:true,yMin:cfg.yMin,yMax:cfg.yMax});
  const by = cfg.sort?.by || 'value'; const dir = cfg.sort?.dir || 'desc';
  items = sortBy(items, by, dir);
  const table=h('table',{class:'table'}, h('thead',null,h('tr',null,
    h('th',{onclick:()=>{ setCfg(id,{sort:{by:'label',dir:(by==='label'&&dir==='asc')?'desc':'asc'}}); render(); },style:'cursor:pointer;'},'Issuer'),
    h('th',{onclick:()=>{ setCfg(id,{sort:{by:'value',dir:(by==='value'&&dir==='asc')?'desc':'asc'}}); render(); },style:'cursor:pointer;'},'Total')
  )), h('tbody',null, ...items.map(r=>h('tr',null,h('td',null,r.label),h('td',null,fmtUSD(r.value))))));
  return [sectionTitle('Exposure by Issuer (total balance)'), chart, table];
}

/* ----- Dashboards ----- */
function ensureDashOrder(dash,key){
  const avail=availableForDashboard(dash);
  let cur=(state[key]||[]).filter(id=>avail.includes(id));
  // If nothing or something was invalid, reset to defaults
  if(!cur.length){ cur=avail.slice(); }
  state[key]=cur;
}
function emptyNotice(){ return h('div',{class:'panel p4'}, h('div',{class:'muted'},'No widgets selected. Click "Customize" above to add widgets.')); }
function buildGrid(orderKey, dash, gridId){
  ensureDashOrder(dash, orderKey);
  const grid=h('div',{class:'grid grid-3',id:gridId});
  const list=(state[orderKey]||[]);
  for(const id of list){
    const meta=(WidgetRegistry && WidgetRegistry[id])? WidgetRegistry[id] : null;
    if(!meta) continue;
    const built = meta.build();
    const el = widget(id, built, state.widgetSize[id]||meta.size||1, state.widgetHeightMode[id]||'auto');
    if (state.ui.customizing===dash) addWidgetControls(el, id, orderKey);
    grid.appendChild(el);
  }
  if(!grid.children.length) grid.appendChild(emptyNotice());
  setTimeout(()=> enableDrag(grid, orderKey), 0);
  return grid;
}
function overview(){
  const orderKey='order_overview', dash='overview', gridId='ov-grid';
  const top= state.ui.customizing===dash ? customizeBar(dash,orderKey,gridId) : controlsRow(dash,orderKey);
  const grid=buildGrid(orderKey,dash,gridId);
  return h('div',null, top, grid);
}
function ccDashboard(){
  const orderKey='order_cc', dash='credit', gridId='cc-grid';
  const top= state.ui.customizing===dash ? customizeBar(dash,orderKey,gridId) : controlsRow(dash,orderKey);
  const grid=buildGrid(orderKey,dash,gridId);
  return h('div',null, top, grid);
}
function finDashboard(){
  const orderKey='order_fin', dash='financials', gridId='fin-grid';
  const top= state.ui.customizing===dash ? customizeBar(dash,orderKey,gridId) : controlsRow(dash,orderKey);
  const grid=buildGrid(orderKey,dash,gridId);
  return h('div',null, top, grid);
}

/* ----- Section containers ----- */
function segTabs(value, list, onChange){ return h('div',{style:'display:flex;gap:6px;margin:6px 0'}, h('div',{style:'display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--panel)'},
  ...list.map(t=>h('button',{'aria-pressed': String(value===t.id), class:'btn tiny', onclick:()=>onChange(t.id)}, t.label))
)); }
function ccSection(){
  const tabs=segTabs(state.ccView, [{id:'dashboard',label:'Dashboard'},{id:'cards',label:'Cards'},{id:'log',label:'Daily Log'}], v=>{ state.ccView=v; save(); render(); });
  const body = state.ccView==='dashboard'? ccDashboard() : state.ccView==='cards'? ccCards() : ccLog();
  return h('div',null, tabs, body);
}
function finSection(){
  const tabs=segTabs(state.finView, [{id:'dashboard',label:'Dashboard'},{id:'accounts',label:'Accounts'},{id:'log',label:'Daily Account Log'},{id:'upcoming',label:'Expenses (7d)'}], v=>{ state.finView=v; save(); render(); });
  const body = state.finView==='dashboard'? finDashboard() : state.finView==='accounts'? finAccounts() : state.finView==='upcoming'? finUpcoming() : finLog();
  return h('div',null, tabs, body);
}

/* ----- Settings section (with debounced company name) ----- */
function settingsSection(){
  const lightKeys=Object.keys(ThemePresets.light);
  const darkKeys=Object.keys(ThemePresets.dark);
  const wrap=h('div',{class:'grid grid-2'});

  // Debounce helpers
  let nameTimer=null;
  function queueCompanySave(){
    clearTimeout(nameTimer);
    nameTimer=setTimeout(()=>{ state.company = state.ui.companyDraft || 'Company Finance'; save(); render(); }, 500);
  }

  const themePanel = h('div',{class:'panel p4'},
   sectionTitle('Theme & Appearance'),
   h('div',{class:'grid grid-2'},
 
     // Mode
     h('div',{class:'field'}, h('label',null,'Mode'),
       h('select',{onchange:e=>{ state.theme=e.target.value; save(); render(); }},
         h('option',{value:'light', selected: state.theme==='light'?'selected':null}, 'Light'),
         h('option',{value:'dark',  selected: state.theme==='dark' ?'selected':null}, 'Dark')
       )
     ),

     // Accent color
     h('div',{class:'field'}, h('label',null,'Accent'),
       h('input',{type:'color', value: state.accentColor||'#2B73F7',
         oninput:e=>{ state.accentColor=e.target.value; save(); }})
     ),

     // Presets
     h('div',{class:'field'}, h('label',null,'Light preset'),
       h('select',{onchange:e=>{ state.themeLightPreset=e.target.value; save(); render(); }},
         ...lightKeys.map(k=> h('option',{value:k, selected: state.themeLightPreset===k?'selected':null}, k)))
     ),
     h('div',{class:'field'}, h('label',null,'Dark preset'),
       h('select',{onchange:e=>{ state.themeDarkPreset=e.target.value; save(); render(); }},
         ...darkKeys.map(k=> h('option',{value:k, selected: state.themeDarkPreset===k?'selected':null}, k)))
     ),

     // Card gradient
     h('div',{class:'field'}, h('label',null,'Card gradient (subtle)'),
       h('input',{type:'range',min:'0',max:'.12',step:'.01',
         value:String(state.ui.gradientAlpha??.06),
         oninput:e=>{ state.ui.gradientAlpha=parseFloat(e.target.value); save(); render(); }})
     ),

     // Radius
     h('div',{class:'field'}, h('label',null,'Corner radius'),
       h('input',{type:'range',min:'10',max:'20',step:'1',
         value:String(state.ui.radiusPx||16),
         oninput:e=>{ state.ui.radiusPx=Number(e.target.value); save(); render(); }})
     ),

     // Center column weight
     h('div',{class:'field'}, h('label',null,'Center column weight'),
       h('input',{type:'range',min:'1.3',max:'1.8',step:'0.1',
         value:String(state.ui.centerWeight||1.6),
         oninput:e=>{ state.ui.centerWeight=Number(e.target.value); save(); render(); }})
     ),

     // NEW: Full-width toggle
     h('div',{class:'field'}, h('label',null,'Full width (ultrawide)'),
       h('select',{onchange:e=>{ state.ui.fullWidth = (e.target.value==='yes'); save(); render(); }},
         h('option',{value:'no',  selected:!state.ui.fullWidth?'selected':null},'No'),
         h('option',{value:'yes', selected: state.ui.fullWidth?'selected':null},'Yes'))
     ),

     // NEW: Max width when not full
     h('div',{class:'field'}, h('label',null,'Max width (px when not full)'),
       h('input',{type:'number', min:'1200', max:'4000',
         value:String(state.ui.contentMaxPx ?? 2200),
         oninput:e=>{
           state.ui.contentMaxPx = clamp(Number(e.target.value||2200), 1200, 4000);
           save(); applyThemeTokens();
         }})
     )

   )
 );

  const orgPanel=h('div',{class:'panel p4'},
    sectionTitle('Branding'),
    h('div',{class:'grid grid-2'},
      (function(){ const val = state.ui.companyDraft || state.company || ''; return h('div',{class:'field'}, h('label',null,'Company Name (updates after you pause typing)'), h('input',{type:'text', value:val, oninput:e=>{ state.ui.companyDraft=e.target.value; queueCompanySave(); }})); })(),
      h('div',{class:'field'}, h('label',null,'Logo (square works best)'),
        h('input',{type:'file',accept:'image/*',onchange:(e)=>{
          const f=e.target.files&&e.target.files[0]; if(!f) return;
          const r=new FileReader(); r.onload = ev=>{ state.logoData=String(ev.target.result||''); save(); render(); };
          r.readAsDataURL(f);
        }})
      ),
      h('div',null, h('button',{class:'btn tiny',onclick:()=>{ state.logoData=''; save(); render(); }},'Clear logo'))
    )
  );

  const uxPanel=h('div',{class:'panel p4'},
    sectionTitle('UX Preferences'),
    h('div',{class:'grid grid-2'},
      h('div',{class:'field'}, h('label',null,'Table density'),
        h('select',{onchange:e=>{ document.body.dataset.density=e.target.value; }},
          h('option',{value:'cozy'},'Cozy'),
          h('option',{value:'compact'},'Compact')
        )
      ),
      h('div',{class:'field'}, h('label',null,'Animations'),
        h('select',{onchange:e=>{ document.body.dataset.anim=e.target.value; }},
          h('option',{value:'on'},'On'), h('option',{value:'off'},'Off')
        )
      ),
      h('div',{class:'field'}, h('label',null,'Number formatting (thousands)'),
        h('select',{onchange:e=>{ state.ui.useGrouping = (e.target.value==='on'); save(); }},
          h('option',{value:'on', selected: state.ui.useGrouping!==false?'selected':null},'On'),
          h('option',{value:'off', selected: state.ui.useGrouping===false?'selected':null},'Off')
        )
      )
    )
  );

  wrap.appendChild(themePanel);
  wrap.appendChild(orgPanel);
  wrap.appendChild(uxPanel);
  return wrap;
}

/* ----- Repair & Render ----- */
function hardRepair(){
  try{
    state.section = ['overview','credit','financials','settings'].includes(state.section)? state.section : 'overview';
    state.ccView = ['dashboard','cards','log'].includes(state.ccView)? state.ccView : 'dashboard';
    state.finView = ['dashboard','accounts','log','upcoming'].includes(state.finView)? state.finView : 'dashboard';
    state.order_overview = availableForDashboard('overview').slice();
    state.order_cc = availableForDashboard('credit').slice();
    state.order_fin = availableForDashboard('financials').slice();
    save();
  }catch(e){ console.error(e); }
  render();
}
function render(){
  applyThemeTokens();
  const root=$('#app'); root.innerHTML='';
  const collapsed = !!state.ui.sidebarCollapsed;
  const layout=h('div',{class:'layout', style:`grid-template-columns:${collapsed? 'var(--sidebar-w-collapsed)':'var(--sidebar-w)'} 1fr`});
  layout.appendChild(appSidebar());
  const main=h('div',{class:'main'});
  main.appendChild(appHeader());
  if (state.section==='overview') main.appendChild( safeSection('Overview', ()=>{ const orderKey='order_overview', dash='overview', gridId='ov-grid'; const top= state.ui.customizing===dash ? customizeBar(dash,orderKey,gridId) : controlsRow(dash,orderKey); const grid=buildGrid(orderKey,dash,gridId); return h('div',null, top, grid); }, ()=>{ state.order_overview=availableForDashboard('overview').slice(); save(); render(); }) );
  if (state.section==='credit') main.appendChild( safeSection('Credit Cards', ()=>{ const orderKey='order_cc', dash='credit', gridId='cc-grid'; const tabs=segTabs(state.ccView, [{id:'dashboard',label:'Dashboard'},{id:'cards',label:'Cards'},{id:'log',label:'Daily Log'}], v=>{ state.ccView=v; save(); render(); }); const top= state.ui.customizing===dash && state.ccView==='dashboard' ? customizeBar(dash,orderKey,gridId) : controlsRow(dash,orderKey); const body = state.ccView==='dashboard'? buildGrid(orderKey,dash,gridId) : state.ccView==='cards'? ccCards() : ccLog(); return h('div',null, tabs, top, body); }, ()=>{ state.ccView='dashboard'; state.order_cc=availableForDashboard('credit').slice(); save(); render(); }) );
  if (state.section==='financials') main.appendChild( safeSection('Financials', ()=>{ const orderKey='order_fin', dash='financials', gridId='fin-grid'; const tabs=segTabs(state.finView, [{id:'dashboard',label:'Dashboard'},{id:'accounts',label:'Accounts'},{id:'log',label:'Daily Account Log'},{id:'upcoming',label:'Expenses (7d)'}], v=>{ state.finView=v; save(); render(); }); const top= state.ui.customizing===dash && state.finView==='dashboard' ? customizeBar(dash,orderKey,gridId) : controlsRow(dash,orderKey); const body = state.finView==='dashboard'? buildGrid(orderKey,dash,gridId) : state.finView==='accounts'? finAccounts() : state.finView==='upcoming'? finUpcoming() : finLog(); return h('div',null, tabs, top, body); }, ()=>{ state.finView='dashboard'; state.order_fin=availableForDashboard('financials').slice(); save(); render(); }) );
  if (state.section==='settings') main.appendChild( safeSection('Settings', ()=>settingsSection(), ()=>{} ) );
  layout.appendChild(main); root.appendChild(layout);
  $('#boot')?.remove();
}
applyThemeTokens(); render();
</script>
</body>
</html>